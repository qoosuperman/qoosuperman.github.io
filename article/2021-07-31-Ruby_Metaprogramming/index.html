<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Anthony&#39;s Blog, about Ruby / Rails / Devops">
    <meta name="keyword" content="">
    <meta property="og:image" content="undefined">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <title>
        
          Synopsis of Ruby Metaprgramming - Anthony Chao | Blog
        
    </title>

    <link rel="canonical" href="https://qoosuperman.github.io/article/2021-07-31-Ruby_Metaprogramming/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css">

    <link rel="stylesheet" href="/css/donate.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <link rel="stylesheet" href="/css/widget.css">

    <link rel="stylesheet" href="/css/rocket.css">

    <link rel="stylesheet" href="/css/signature.css">

    <link rel="stylesheet" href="/css/toc.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
<link rel="alternate" href="/atom.xml" title="Anthony Chao" type="application/atom+xml">
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('https://images.unsplash.com/photo-1627637819794-fba32f82be16?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;ixlib=rb-1.2.1&amp;auto=format&amp;fit=crop&amp;w=1789&amp;q=80')
            /*post*/
        
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#Ruby" title="Ruby">Ruby</a>
                            
                        </div>
                        <h1>Synopsis of Ruby Metaprgramming</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by Anthony Chao on
                            2021-07-31
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Anthony Chao</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archive/">Archive</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <ul>
<li><a href="#ch1-object-model">Chapter1 Object model</a></li>
<li><a href="#ch2-method">Chapter2 Method</a></li>
<li><a href="#ch3-blocks">Chapter3 Blocks</a></li>
<li><a href="#ch4-class-definition">Chapter4 Class definition</a></li>
<li><a href="#ch5-Code-That-Writes-code">Chapter5 Code That Writes Code</a></li>
<li><a href="#ch6-rails-source-code">Chapter6 Rails Source Code</a></li>
</ul>
<p>這篇文章是閱讀 Metaprgramming Ruby 2 這本書的筆記，內容幾乎都來自於書中，看完之後覺得這本書寫得真好，有種相見恨晚的感覺</p>
<p>因為只是摘錄書內重點，一定有些部分沒寫到，推薦有在寫 Ruby 的朋友們一定要看看這本書！<br>
<img src="https://i.imgur.com/QliVMKH.jpg" alt="Metaprgramming Ruby 2"></p>
<h1>Ch1 Object model</h1>
<h2>Open class</h2>
<p><code>class</code> 這個關鍵字在 ruby 中像是一個 scope operator，可以把我們帶到這個 class 的上下文中，在裡面定義方法，這技巧叫做 open class</p>
<p>他有一個比較不好聽的說法叫做 monkey patch</p>
<p>在 ruby 裡面，如果打開一個 instance，看不到他身上存著方法，只有他身上的 instance_variable 跟他屬於哪一個 class</p>
<p>而這些方法是定義在這個 class 裡面，我們可以說 object 身上的 method 來自 MyClass 定義的的 instance methods</p>
<p><img src="https://i.imgur.com/Qp1HjYa.png" alt="method-come-from-class"></p>
<p>有幾個很容易 confuse 的點：在 ruby 裡面幾乎所有東西都是 object，連 class 也是 object，那每個 class 屬於什麼 class?</p>
<p>答案是 Class，然後 Class 的 class 還是 Class</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; String<span class="class">.<span class="keyword">class</span></span></span><br><span class="line">Class</span><br><span class="line">&gt; Class<span class="class">.<span class="keyword">class</span></span></span><br><span class="line">Class</span><br></pre></td></tr></table></figure>
<p>ruby 另一個很容易讓人混淆的部分就是： Class 的 superclass 是 module</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; Class.superclass</span><br><span class="line"> =&gt; Module</span><br></pre></td></tr></table></figure>
<p>所以 Module 的概念跟 Class 其實非常接近，儘管在 ruby 裡面這兩個東西很多場合可以替換，但為了表明 code 意圖，最好按照 convention 來使用</p>
<p>就像前面，MyClass 定義他下面的 object 有哪些 instance_methods，Class 也會定義各個 class (像是 String) 的 instance_methods</p>
<p>這下面的 false 表示忽略繼承來的方法，而 Class 的 superclass 是 Module，所以這也代表 Class 比起 Module 多了一下這些方法</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; Class.instance_methods(<span class="literal">false</span>)</span><br><span class="line">[<span class="symbol">:allocate</span>, <span class="symbol">:superclass</span>, <span class="symbol">:new</span>]</span><br></pre></td></tr></table></figure>
<p>其中我們可以用 superclass 看到這個 class 繼承自哪一個 class</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">2.6.3 :012 &gt;</span> Array.superclass</span><br><span class="line"> =&gt; Object</span><br><span class="line"><span class="meta">2.6.3 :013 &gt;</span> Object.superclass</span><br><span class="line"> =&gt; BasicObject</span><br><span class="line"><span class="meta">2.6.3 :014 &gt;</span> BasicObject.superclass</span><br><span class="line"> =&gt; nil</span><br></pre></td></tr></table></figure>
<h2>Constants</h2>
<p>在 ruby 裡面任何大寫開頭的字都是 constant，包括 class 跟 module 的名字，而且 constant 是可以改的，雖然會跳警告</p>
<p>因此我們可以把 String 這個 class 名字改掉，系統就會崩潰</p>
<p>他跟變數的最大區別在於 scope，他有自己的作用域規則：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Y = <span class="string">'root level constant'</span></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">M</span></span></span><br><span class="line">  Y = <span class="string">'M level contstant'</span></span><br><span class="line">  puts Y    <span class="comment"># 'M level contstant'</span></span><br><span class="line">  puts <span class="symbol">:</span><span class="symbol">:Y</span>  <span class="comment"># 'root level constant'</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">    Y = <span class="string">'C level constant'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>上面的例子裡面，每個不同 module / class 裡面的 Y constant 不同，很像文件在不同 folder 底下可以有一樣的名字，但內容可以不同</p>
<p>特別的是 Module 本身有一個 instance method <code>constants</code>，還有一個 class method <code>constants</code><br>
instance method 這個會回傳當前 scope 的所有 constant，就像文件系統的 ls<br>
class method 這會回傳所有 root level 的 constant，包括 class name</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; M.constants</span><br><span class="line"> =&gt; [<span class="symbol">:C</span>, <span class="symbol">:Y</span>]</span><br><span class="line">Module.constants</span><br><span class="line"> =&gt; [<span class="symbol">:NotImplementedError</span>, <span class="symbol">:NameError</span>,...]</span><br></pre></td></tr></table></figure>
<h2>Ancestors chain / method lookup</h2>
<p>在 ruby 裡面要找到物件裡面的方法，尋找的方式是往右一步再往上尋找，像是下面這樣</p>
<p>比較特別的是 module 也會在這個 ancestors chain 裡面，如果使用 include，會放在 ancestor chain 裡面這個 class 上面，如果使用 prepend，就會放在下面<br>
<img src="https://i.imgur.com/Sa5ytwN.png" alt="ancestors-chain"></p>
<p>如果是同時 include 多個方法，像下面這樣：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span></span></span><br><span class="line">  <span class="keyword">include</span> Document</span><br><span class="line">  <span class="keyword">include</span> Printable</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>在 ancestors chain 裡面，會先把 document 放到 Book 上面，接著再把 Printable 放在 Book 上面</p>
<p>所以先找到的 method 會是 Printable 裡面的 method<br>
<img src="https://i.imgur.com/ySwIbgJ.png" alt="ancestors-chain-of-b"></p>
<h2>Kernal module</h2>
<p>在 ruby 裡面有一些方法是隨時都可以用的，像是 <code>puts</code>, <code>print</code></p>
<p>這是因為這些方法放在 Kernal module裡面，然後 Object 又 include 了 Kernal module，所以基本上所有 object 都可以使用</p>
<h2>self</h2>
<p>在 ruby 每個方法執行的時候，都要有個 receiver，如果沒有 receiver，那預設對象會是 self</p>
<p>以下面的例子來說，我們使用 testing_self 這個 method 的時候，當下的 reciever <code>obj</code> 就變成 self</p>
<p>所以不管是 <code>@var = 10</code> 或者 <code>my_method</code> 都是把 <code>obj</code> 當作對象來操作</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">testing_self</span></span></span><br><span class="line">    @var = <span class="number">10</span></span><br><span class="line">    my_method</span><br><span class="line">    <span class="keyword">self</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">my_method</span></span></span><br><span class="line">    @var = @var + <span class="number">1</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">&gt; obj = MyClass.new</span><br><span class="line">&gt; obj.testing_self</span><br><span class="line">&lt;<span class="comment">#MyClass.... <span class="doctag">@var</span>=11&gt;</span></span><br></pre></td></tr></table></figure>
<h2>Refine</h2>
<p>refine 是另一個 open class 的方式，他可以避免原本 open class 的全域修改，但也可能造成其他預料不到的問題…</p>
<p>refine 的作用只在三種情況生效：</p>
<ol>
<li>refine code 內部</li>
<li>如果是在 block 裡面使用 using，則作用到 block 結束，如果是在文件裡面的 scope 使用，則作用到文件結束</li>
<li>如果是在 irb 內的 top level context(main) 使用，則作用在整個 irb 裡面</li>
</ol>
<p>要讓 refine 的 code 生效要搭配 <code>using</code> 使用，方法可以看下面例子：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StringExtensions</span></span></span><br><span class="line">  refine String <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reverse</span></span></span><br><span class="line">      <span class="string">'esrever'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">StringStuff</span></span></span><br><span class="line">  using StringExtensions</span><br><span class="line">  <span class="string">'my_string'</span>.reverse <span class="comment"># 'esrever'</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">&gt; <span class="string">'my_string'</span>.reverse <span class="comment"># ngirts_ym</span></span><br></pre></td></tr></table></figure>
<p>可能造成的問題，可以參考下面的例子：<br>
雖然我們在 refine 裡面修改了 MyClass 的 my_method</p>
<p>但 MyClass 裡面 another_method 調用 my_method 是在使用 using 之前，所以還是沒有修改的那個</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">my_method</span></span></span><br><span class="line">    <span class="string">'original_method'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">another_method</span></span></span><br><span class="line">    my_method</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">MyClassRefinement</span></span></span><br><span class="line">  refine MyClass <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">my_method</span></span></span><br><span class="line">      <span class="string">'refined my method'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">using MyClassRefinement</span><br><span class="line">puts MyClass.new.my_method <span class="comment"># refined my method</span></span><br><span class="line">puts MyClass.new.another_method <span class="comment"># original_method</span></span><br></pre></td></tr></table></figure>
<hr>
<h1>Ch2 Method</h1>
<p>在 ruby 這種動態語言裡面，可以用一些方式減少重複定義類似的 method，其中比較常見的像是 <code>define_method</code> 跟 <code>method_missing</code> 這兩種方式</p>
<h2><code>send</code> / Dynamic Dispatch</h2>
<p>要搭配動態方法，很容易需要搭配 <code>send</code> 這個 method</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; obj.my_method(<span class="number">3</span>)</span><br><span class="line"><span class="comment"># 會等於</span></span><br><span class="line">&gt; obj.send(<span class="symbol">:my_method</span>, <span class="number">3</span>)</span><br></pre></td></tr></table></figure>
<p>因為 method 名字變成了參數，所以你可以在最後一步才去改變要使用哪一個 method，這技巧叫做 Dynamic Dispatch，以 pry 的例子來看看 send 可以怎麼使用</p>
<p>pry 本身有一些 attributes，然後有 refresh 這個 method(目前最新版本的似乎已經拿掉)，可以把某些 attribute 改成丟進去的參數，其他的 attribute 回歸預設值，像是下面這樣</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; pry = Pry.new</span><br><span class="line">&gt; pry.memory_size <span class="comment"># 100</span></span><br><span class="line">&gt; pry.memory_size = <span class="number">101</span></span><br><span class="line">&gt; pry.memory_size <span class="comment"># 101</span></span><br><span class="line">&gt; pry.quiet       <span class="comment"># true</span></span><br><span class="line">&gt; pry.refresh(<span class="symbol">quiet:</span> <span class="literal">false</span>) <span class="comment"># 同時把 quiet 設成 false，把其他 attribute 回歸預設值</span></span><br><span class="line">&gt; pry.memory_size <span class="comment"># 100   memory_size 被回歸 default 值</span></span><br><span class="line">&gt; pry.quiet       <span class="comment"># false</span></span><br></pre></td></tr></table></figure>
<p>如果用直觀的寫法可能會寫成：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">refresh</span><span class="params">(options = &#123;&#125;)</span></span></span><br><span class="line">  defaults[<span class="symbol">:memory_size</span>] = Pry.memory_size <span class="comment"># class method 會直接拿到預設值</span></span><br><span class="line">  <span class="keyword">self</span>.memory_size = options[<span class="symbol">:memory_size</span>] <span class="keyword">if</span> options[<span class="symbol">:memory_size</span>]</span><br><span class="line"></span><br><span class="line">  defaults[<span class="symbol">:quiet</span>] = Pry.quiet</span><br><span class="line">  <span class="keyword">self</span>.quiet = options[<span class="symbol">:quiet</span>] <span class="keyword">if</span> options[<span class="symbol">:quiet</span>]</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>如果用 Dynamic Dispatch 則可以寫成：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">refresh</span><span class="params">(options = &#123;&#125;)</span></span></span><br><span class="line">  defaults = &#123;&#125;</span><br><span class="line">  attributes = [<span class="symbol">:input</span>, <span class="symbol">:memory_size</span>, <span class="symbol">:quiet</span> ...]</span><br><span class="line">  attributes.each <span class="keyword">do</span> <span class="params">|attribute|</span></span><br><span class="line">    defaults[attribute] = Pry.send(attribute)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  defaults.merge!(options).each <span class="keyword">do</span> <span class="params">|key, value|</span></span><br><span class="line">    send(<span class="string">"<span class="subst">#&#123;key&#125;</span>="</span>, value) <span class="keyword">if</span> respond_to?(<span class="string">"<span class="subst">#&#123;key&#125;</span>="</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2>define_method / Dynamic Method</h2>
<p>如果現在有一段 code 要重構，其中 mouse 跟 cpu 的構造非常相似：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Computer</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(computer_id, data_source)</span></span></span><br><span class="line">    @id = computer_id</span><br><span class="line">    @data_source = data_source</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">mouse</span></span></span><br><span class="line">    info = @data_source.get_mouse_info(@id)</span><br><span class="line">    price = @data_source.get_mouse_price(@id)</span><br><span class="line">    result = <span class="string">"Mouse: <span class="subst">#&#123;info&#125;</span> ($<span class="subst">#&#123;price&#125;</span>)"</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"* <span class="subst">#&#123;result&#125;</span>"</span> <span class="keyword">if</span> price &gt;= <span class="number">100</span></span><br><span class="line">    result</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">cpu</span></span></span><br><span class="line">    info = @data_source.get_cpu_info(@id)</span><br><span class="line">    price = @data_source.get_cpu_price(@id)</span><br><span class="line">    result = <span class="string">"Cpu: <span class="subst">#&#123;info&#125;</span> ($<span class="subst">#&#123;price&#125;</span>)"</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"* <span class="subst">#&#123;result&#125;</span>"</span> <span class="keyword">if</span> price &gt;= <span class="number">100</span></span><br><span class="line">    result</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>如果改成 Dynamic method:<br>
其中因為 <code>define_component</code> 是在 class 的 scope 裡面使用，所以他是 class method</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Computer</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(computer_id, data_source)</span></span></span><br><span class="line">    @id = computer_id</span><br><span class="line">    @data_source = data_source</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">define_component</span><span class="params">(name)</span></span></span><br><span class="line">    define_method(name) <span class="keyword">do</span></span><br><span class="line">      info = @data_source.send(<span class="string">"get_<span class="subst">#&#123;name&#125;</span>_info"</span>, @id)</span><br><span class="line">      price = @data_source.send(<span class="string">"get_<span class="subst">#&#123;name&#125;</span>_price"</span>, @id)</span><br><span class="line">      result = <span class="string">"<span class="subst">#&#123;name.capitalize&#125;</span>: <span class="subst">#&#123;info&#125;</span> ($<span class="subst">#&#123;price&#125;</span>)"</span></span><br><span class="line">      <span class="keyword">return</span> <span class="string">"* <span class="subst">#&#123;result&#125;</span>"</span> <span class="keyword">if</span> price &gt;= <span class="number">100</span></span><br><span class="line">      result</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  define_component <span class="symbol">:mouse</span></span><br><span class="line">  define_component <span class="symbol">:cpu</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>這一段 code 甚至可以再進化，在 initialize 的時候直接去看這個 instance 有哪些 get_xxx_info 的方法，直接在 Computer 這個 class 裡面執行 define_component</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Computer</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(computer_id, data_source)</span></span></span><br><span class="line">    @id = computer_id</span><br><span class="line">    @data_source = data_source</span><br><span class="line">    data_source.methods.grep(<span class="regexp">/^get_(.*)_info$/</span>) &#123; Computer.define_component $1 &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">define_component</span><span class="params">(name)</span></span></span><br><span class="line">    ...</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>其中 <code>$1</code> 這個全域變數抓的是 grep 裡面符合 <code>()</code> 裡面 RegExp 的東西<br>
ex.</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span></span><br><span class="line">    <span class="keyword">self</span>.methods.grep(<span class="regexp">/^respond(.*)/</span>) &#123; puts $1.to_s &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">&gt; c = MyClass.new</span><br><span class="line"><span class="comment"># _to? (從 respond_to? 來的)</span></span><br></pre></td></tr></table></figure>
<h2>method_missing / Ghost Method / Dynamic Proxy</h2>
<p>在 ruby 裡面要找某個 receiver 的 method，會從他的 ancestors chain 一路往上查找，如果都沒有，他會 call <code>method_missing</code> 這個 method，他是 BasicObject 的 private method，又所有物件都會繼承 BasicObject，所以大家都有這個 method</p>
<p>因此我們可以覆寫不同 class 的 method_missing method，來攔截這個尋找方法的 chain，但要記得如果 ancestors chain 裡面就有這個 method，那是絕對不會跑到 method_missing 那邊去的</p>
<p>比方說 <code>Hashie::Mash</code> 這個 class 有點像加強版的 OpenStruct</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'hashie'</span></span><br><span class="line"></span><br><span class="line">icecream = Hashie::Mash.new</span><br><span class="line">icecream.flavor = <span class="string">'strawberry'</span></span><br><span class="line">icecream.falvor</span><br></pre></td></tr></table></figure>
<p>看看 source_code 怎麼做到的</p>
<p>如果自己有這個 method 名字的 key，那就回傳這個值，如果這個方法用 <code>=</code> 結尾，那就把這個 key value pair 加進來</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">ALLOWED_SUFFIXES = <span class="string">%w[? ! = _]</span>.freeze</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">method_missing</span><span class="params">(method_name, *args, &amp;blk)</span></span> <span class="comment"># rubocop:disable Style/MethodMissing</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">self</span>.[](method_name, &amp;blk) <span class="keyword">if</span> key?(method_name)</span><br><span class="line">  name, suffix = method_name_and_suffix(method_name)</span><br><span class="line">  <span class="keyword">case</span> suffix</span><br><span class="line">  <span class="keyword">when</span> <span class="string">'='</span>.freeze</span><br><span class="line">    assign_property(name, args.first)</span><br><span class="line">  <span class="keyword">when</span> <span class="string">'?'</span>.freeze</span><br><span class="line">    !!<span class="keyword">self</span>[name]</span><br><span class="line">  <span class="keyword">when</span> <span class="string">'!'</span>.freeze</span><br><span class="line">    initializing_reader(name)</span><br><span class="line">  <span class="keyword">when</span> <span class="string">'_'</span>.freeze</span><br><span class="line">    underbang_reader(name)</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">self</span>[method_name]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">method_name_and_suffix</span><span class="params">(method_name)</span></span></span><br><span class="line">  method_name = method_name.to_s</span><br><span class="line">  <span class="keyword">if</span> method_name.end_with?(*ALLOWED_SUFFIXES)</span><br><span class="line">    [method_name[<span class="number">0</span>..-<span class="number">2</span>], method_name[-<span class="number">1</span>]]</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    [method_name[<span class="number">0</span>..-<span class="number">1</span>], <span class="literal">nil</span>]</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">assign_property</span><span class="params">(name, value)</span></span></span><br><span class="line">  <span class="keyword">self</span>[name] = value</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>另一個 Dynamic Proxy 的技巧可以參考 Ghee 的案例</p>
<p>要使用 Ghee 的話很簡單</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'ghee'</span></span><br><span class="line">gh = Ghee.basic_auth(<span class="string">'account'</span>, <span class="string">'password'</span>)</span><br><span class="line">all_gists = gh.users(<span class="string">'user01'</span>).gists</span><br><span class="line">a_gist = all_gists[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">a_gist.url <span class="comment"># some_url</span></span><br><span class="line">a_gist.description <span class="comment"># some word</span></span><br><span class="line"></span><br><span class="line">a_gist.star <span class="comment"># 訂閱這個 gist，在有變動的時候通知我</span></span><br></pre></td></tr></table></figure>
<p>其中 gist 的 class 是 <code>Ghee::API::Gists::Proxy</code> 他又繼承 <code>Ghee::ResourceProxy</code></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ghee</span></span></span><br><span class="line">  <span class="class"><span class="keyword">module</span> <span class="title">API</span></span></span><br><span class="line">    <span class="class"><span class="keyword">module</span> <span class="title">Gists</span></span></span><br><span class="line">      <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> &lt; :<span class="title">Ghee::ResourceProxy</span></span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">star</span></span></span><br><span class="line">          connection.put(<span class="string">"<span class="subst">#&#123;path_prefix&#125;</span>/star"</span>.status) == <span class="number">204</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ghee</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">ResourceProxy</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">method_missing</span><span class="params">(message, *args, &amp;block)</span></span></span><br><span class="line">      subject.send(message, *args, &amp;block)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">subject</span></span></span><br><span class="line">      @subject <span class="params">||</span>= connection.get(path_prefix)&#123; <span class="params">|req|</span> req.params.merge!params &#125;.body</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>這其中的設計在於，如果今天我呼叫出來的這個 class 本身有一些特殊行為，我需要定義在他的 class 裡面，像是 <code>star</code> 這個 method</p>
<p>但如果是一般常見的 method 只是要拿一個值，會回到 method_missing 這個方法，這個 subject 的回傳值會是前面講到的 <code>Hashie::Mash</code> 物件</p>
<p>也就是說，我今天拿到的 gist 物件，我使用 <code>a_gist.url</code>，因為在自己的 class 沒有定義 <code>url</code> method，所以會去呼叫 <code>Ghee::ResourceProxy</code> 的 <code>method_missing</code> 方法，因為 <code>Hashie::Mash</code> 也沒有定義 <code>url</code> 方法，所以會呼叫 <code>Hashie::Mash</code> 的 <code>method_missing</code> 方法，最後拿到 url 的值，中間總共使用了兩次的 <code>method_missing</code> 技巧</p>
<p>這樣做的好處在於說，如果今天 Github 的 gist api 多回傳了一個欄位，那 Ghee 這邊的 code 也不用變動，因為他的 method 也是動態產生的</p>
<p>在這樣的設計裡面，呼叫 <code>star</code> 跟 <code>url</code> 所代理的介面是不同的，所以叫做 <code>Dynamic Proxy</code></p>
<hr>
<p>現在用 method_missing 的方式改寫同一段 code</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Computer</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(computer_id, data_source)</span></span></span><br><span class="line">    @id = computer_id</span><br><span class="line">    @data_source = data_source</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">mouse</span></span></span><br><span class="line">    info = @data_source.get_mouse_info(@id)</span><br><span class="line">    price = @data_source.get_mouse_price(@id)</span><br><span class="line">    result = <span class="string">"Mouse: <span class="subst">#&#123;info&#125;</span> ($<span class="subst">#&#123;price&#125;</span>)"</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"* <span class="subst">#&#123;result&#125;</span>"</span> <span class="keyword">if</span> price &gt;= <span class="number">100</span></span><br><span class="line">    result</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">cpu</span></span></span><br><span class="line">    info = @data_source.get_cpu_info(@id)</span><br><span class="line">    price = @data_source.get_cpu_price(@id)</span><br><span class="line">    result = <span class="string">"Cpu: <span class="subst">#&#123;info&#125;</span> ($<span class="subst">#&#123;price&#125;</span>)"</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"* <span class="subst">#&#123;result&#125;</span>"</span> <span class="keyword">if</span> price &gt;= <span class="number">100</span></span><br><span class="line">    result</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>改寫後會變成</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Computer</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(computer_id, data_source)</span></span></span><br><span class="line">    @id = computer_id</span><br><span class="line">    @data_source = data_source</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">method_missing</span><span class="params">(name)</span></span></span><br><span class="line">    <span class="keyword">super</span> <span class="keyword">if</span> !@data_source.respond_to?(<span class="string">"get_<span class="subst">#&#123;name&#125;</span>_info"</span>)</span><br><span class="line">    info = @data_source.send(<span class="string">"get_<span class="subst">#&#123;name&#125;</span>_info"</span>, @id)</span><br><span class="line">    price = @data_source.send(<span class="string">"get_<span class="subst">#&#123;name&#125;</span>_price"</span>, @id)</span><br><span class="line">    result = <span class="string">"<span class="subst">#&#123;name.capitalize&#125;</span>: <span class="subst">#&#123;info&#125;</span> ($<span class="subst">#&#123;price&#125;</span>)"</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"* <span class="subst">#&#123;result&#125;</span>"</span> <span class="keyword">if</span> price &gt;= <span class="number">100</span></span><br><span class="line">    result</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>但如果問 instance 是否支援 ghost methods，他會睜眼說瞎話</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">my_computer = Computer.new(<span class="number">42</span>, DS.new)</span><br><span class="line">my_computer.cpu <span class="comment"># Cpu: 2.9Ghz quad-core ($120)</span></span><br><span class="line">my_computer.respond_to?(<span class="symbol">:cpu</span>) <span class="comment"># false</span></span><br></pre></td></tr></table></figure>
<p>在 <code>respond_to?</code> 裡面，如果這個 method 是一個 ghost method，那他會改去呼叫 <code>respond_to_missing?</code> 這個 method，我們可以把它想像成 <code>ghost_method?</code>，而 Object 裡面的 respond_to_missing 預設是都 return false，如果我們要使用 ghost method 最好都連同 <code>respond_to_missing</code> 這個 method 一起改</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Computer</span></span></span><br><span class="line">  ...</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">respond_to_missing?</span><span class="params">(method, include_private = <span class="literal">false</span>)</span></span></span><br><span class="line">    @data_source.respond_to?(<span class="string">"get_<span class="subst">#&#123;method&#125;</span>_info"</span>) <span class="params">||</span> <span class="keyword">super</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2>Blank Slates</h2>
<p>如果需要使用 method_missing 作為這個 class 主要支撐，那通常會需要他繼承一個足夠乾淨的 class，如果 class 沒有寫繼承自誰的話，預設都是繼承自 Object，如果想要更乾淨，可以繼承自 <code>BasicObject</code>，這種有極少方法的 class 叫做 <code>Blank Slate</code></p>
<p>又或者我們可以使用 <code>undef_method</code> 跟 <code>remove_method</code> 讓一個 class 變成 Blank Slate</p>
<h3>undef_method / remove_method</h3>
<p>remove_method 比較溫柔，他只刪除 receiver 自己的方法，保留繼承來的方法</p>
<p>undef method 則是自己的方法 / 繼承來的方法都刪除</p>
<p>什麼時候會用到他們呢？可以參考 xml builder 這個 library</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'builder'</span></span><br><span class="line">xml = Builder::XmlMarkup.new(<span class="symbol">:target</span> =&gt; STDOUT, <span class="symbol">:indent=&gt;</span><span class="number">2</span>)</span><br><span class="line">xml.semester &#123;</span><br><span class="line">  xml<span class="class">.<span class="keyword">class</span> '<span class="title">Class1</span>'</span></span><br><span class="line">  xml<span class="class">.<span class="keyword">class</span> '<span class="title">Class2</span>'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這段 code 會產生這樣的 xml:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">semester</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">class</span>&gt;</span>Class1<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">class</span>&gt;</span>Class2<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">semester</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>但 class 是 ruby 裡面繼承自 Object 的 method，他是怎麼避免的？<br>
原來他是把這些方法都 undefine 掉，只保留所有的保留方法(以 <code>_</code> 為開頭的方法)，還有 instance_eval 這個方法</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlankSlate</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">hide</span><span class="params">(name)</span></span></span><br><span class="line">    <span class="keyword">if</span> instance_methods.<span class="keyword">include</span>?(name.blank_slate_as_name) &amp;&amp; name !~ <span class="regexp">/^(_|instance_eval)/</span></span><br><span class="line">    undef_method name</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  ....</span><br><span class="line"></span><br><span class="line">  instance_methods.each &#123; <span class="params">|m|</span> hide(m) &#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>對比動態產生方法跟 ghost methods 這兩種策略，其實 ghost methods 比較可能帶來容易讓人困惑的 bug，動態方法產生的方法還是普通的方法，只不過他們是透過 <code>define_method</code> 定義的，而 ghost_methods 並不是真正的 method</p>
<p>但像是 XML builder 的例子， tag 的種類是無窮的，這時候是只能使用 ghost methods</p>
<p>所以除非必要使用，否則建議盡量不使用 ghost methods</p>
<hr>
<h1>Ch3 Blocks</h1>
<p>Block 基本使用： 只有在使用方法的時候才可以定義一個 block，block 會直接被傳給這個方法，在 method 裡面可以用 <code>yield</code> 使用 block 的內容</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">a_method</span><span class="params">(a, b)</span></span></span><br><span class="line">  a + <span class="keyword">yield</span>(a, b)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">a_method(<span class="number">1</span>, <span class="number">2</span>) &#123; <span class="params">|x, y|</span> (x + y)* <span class="number">3</span> &#125; <span class="comment"># 10</span></span><br></pre></td></tr></table></figure>
<p>那如果想要做一個 <code>with</code> 方法，在 <code>with</code> 的 block 裡面不管發生什麼事情，離開這個 block 的時候要 trigger <code>dispose</code> 這個 method 的話怎麼做？</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Kernal</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">with</span><span class="params">(resource)</span></span></span><br><span class="line">    <span class="keyword">begin</span></span><br><span class="line">      <span class="keyword">yield</span></span><br><span class="line">    <span class="keyword">ensure</span></span><br><span class="line">      resource.dispose</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">with(conn) &#123;</span><br><span class="line">  conn.get_data  <span class="comment"># 不管哪裡失敗，確保最後會把連線 release</span></span><br><span class="line">  conn.do_another_task</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2>Blocks are closure</h2>
<p>首先回到 code 的運行，其實需要兩個條件：1. code 本身 2. binding</p>
<p><img src="https://i.imgur.com/y88TcH7.png" alt="code-aned-binding"></p>
<p>那 block 的 binding 從哪裡來？ 當 block 被傳給一個 method，他會帶著這些 binding 一起進去方法</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_method</span></span></span><br><span class="line">  x = <span class="string">'GoodBye'</span></span><br><span class="line">  <span class="keyword">yield</span>(<span class="string">'cruel'</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">x = <span class="string">'Hello'</span></span><br><span class="line">me_method &#123; <span class="params">|y|</span> <span class="string">"<span class="subst">#&#123;x&#125;</span>, <span class="subst">#&#123;y&#125;</span> world"</span> &#125; <span class="comment"># "Hello, cruel world"</span></span><br></pre></td></tr></table></figure>
<p>從上面的例子看到，雖然在 method 裡面也有一個 x 變數，但 block 裡面拿到的是 block 定義當下的 x 變數，方法裡面的 x 對 block 來說是看不到的</p>
<p>另外也可以在 block 裡面定義變數，但這些變數在 block 結束就會消失了，因為這些特性，有些人把 block 稱為 closure</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">just_yield</span></span></span><br><span class="line">  <span class="keyword">yield</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">top_level_variable = <span class="number">1</span></span><br><span class="line">just_yield <span class="keyword">do</span></span><br><span class="line">  top_level_variable += <span class="number">1</span></span><br><span class="line">  local_variable = <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">top_level_variable <span class="comment"># 2</span></span><br><span class="line">local_variable     <span class="comment"># Error</span></span><br></pre></td></tr></table></figure>
<h2>scope</h2>
<p>在 ruby 裡面不同 scope 之間的 scope 是截然分開的，一但進去新的 scope，原本的 binding 會被替換成新的 binding</p>
<p>ruby 會在三個地方關閉前一個 scope 然後打開一個新的 scope，分別是 <code>class</code> / <code>module</code> / <code>def</code>，我們可以稱他們 <code>Scope Gate</code></p>
<p>而在 class / module 跟 def 之間還有微妙的區別，在 class/module 裡面的 code 會馬上執行， method 裡面的不會</p>
<p>另外要注意，如果像下面那樣 call 兩次 my_method，每一次 call method 都會重新打開新的 scope，所以第二次 call 的時候，原本的 v3 已經消失了，並且重新定義新的 v3 variable</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">v1 = <span class="number">1</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>    <span class="comment"># 進入 class</span></span></span><br><span class="line">  v2 = <span class="number">2</span></span><br><span class="line">  local_variables <span class="comment">#[:v2]</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">my_method</span>   <span class="comment"># 進入 def</span></span></span><br><span class="line">    v3 = <span class="number">3</span></span><br><span class="line">    local_variables</span><br><span class="line">  <span class="keyword">end</span>             <span class="comment"># 離開 def</span></span><br><span class="line">  local_variables <span class="comment"># [:v2]</span></span><br><span class="line"><span class="keyword">end</span>               <span class="comment"># 離開 class</span></span><br><span class="line"></span><br><span class="line">obj = MyClass.new</span><br><span class="line">obj.my_method  <span class="comment"># [:v3]</span></span><br><span class="line">obj.my_method  <span class="comment"># [:v3]</span></span><br><span class="line">local_variables <span class="comment">#[:v1, :obj]</span></span><br></pre></td></tr></table></figure>
<p>那我們如果想要讓他們在同一個 scope，一起 share 一個 variable 怎麼做，那就是不用到這些 scope gate</p>
<p>前面有提到 block 會把當下定義 block 的 binding 帶進來，這個技巧叫做 flat scope</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">my_var = <span class="string">'Success'</span></span><br><span class="line">MyClass = Class.new <span class="keyword">do</span></span><br><span class="line">  puts <span class="string">"<span class="subst">#&#123;my_var&#125;</span> in the class definition"</span></span><br><span class="line"></span><br><span class="line">  define_method <span class="symbol">:my_method</span> <span class="keyword">do</span></span><br><span class="line">    <span class="string">"<span class="subst">#&#123;my_var&#125;</span> in the method"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">MyClass.new.my_method</span><br><span class="line"><span class="comment"># Success in the class definition</span></span><br><span class="line"><span class="comment"># Success in the method</span></span><br></pre></td></tr></table></figure>
<h2>instance_eval</h2>
<p>instance_eval 這個 method 可以戳破封裝</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span></span><br><span class="line">    @v = <span class="number">1</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">obj = MyClass.new</span><br><span class="line"></span><br><span class="line">obj.instance_eval <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">self</span>      <span class="comment"># &lt;MyClass:0x3.. <span class="doctag">@v</span>=1&gt;</span></span><br><span class="line">  @v        <span class="comment"># 1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">v = <span class="number">2</span></span><br><span class="line">obj.instance_eval &#123; @v = v &#125;</span><br><span class="line">obj.instance_eval &#123; @v &#125; <span class="comment"># 2</span></span><br></pre></td></tr></table></figure>
<p>可以看到範例中 instance_eval 的 block 裡面，self 變成 receiver</p>
<p>而且因為他是在扁平 scope 裡面使用，所以可以使用 binding 裡的東西，因此可以改變一個 obj 的 instance varaible</p>
<p>instance_eval 還有一個兄弟 instance_exec，跟 instance_eval 比起來方便了一點，因為它可以傳參數進去</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span></span><br><span class="line">    @x = <span class="number">1</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">twisted_method</span></span></span><br><span class="line">    @y = <span class="number">2</span></span><br><span class="line">    C.new.instance_eval &#123; <span class="string">"@x: <span class="subst">#&#123;@x&#125;</span>, @y: <span class="subst">#&#123;@y&#125;</span>"</span> &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">D.new.twisted_method <span class="comment"># "<span class="doctag">@x</span>: 1, <span class="doctag">@y</span>: "</span></span><br></pre></td></tr></table></figure>
<p>在執行之前，我們可能會想說，因為他在一個扁平的 scope 裡面，所以可以吃到 @y 參數，不過 instance_variable 會看當時的 self 是誰，而當時的 C 的 instance 並沒有 @y instance_variable，所以會是 nil</p>
<p>我們必須改成這樣</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span></span><br><span class="line">    @x = <span class="number">1</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">twisted_method</span></span></span><br><span class="line">    @y = <span class="number">2</span></span><br><span class="line">    C.new.instance_exec(@y) &#123; <span class="params">|y|</span> <span class="string">"@x: <span class="subst">#&#123;@x&#125;</span>, @y: <span class="subst">#&#123;y&#125;</span>"</span> &#125;</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">D.new.twisted_method <span class="comment"># "<span class="doctag">@x</span>: 1, <span class="doctag">@y</span>: 2"</span></span><br></pre></td></tr></table></figure>
<h2>Callable Object</h2>
<p>有三個方式可以打包 code 之後再執行，他們都可以用 call 方法執行：</p>
<ol>
<li>proc</li>
<li>lambda</li>
<li>method</li>
</ol>
<p>比方說</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">inc = Proc.new &#123; <span class="params">|x|</span> x + <span class="number">1</span> &#125;</span><br><span class="line">inc.call(<span class="number">2</span>) <span class="comment"># 3</span></span><br></pre></td></tr></table></figure>
<p>這個技巧叫做 deferred evaluation，延遲一些時間再執行的意思</p>
<p>Lambda 則有兩種表示方式</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p = -&gt;(x) &#123; x + <span class="number">1</span> &#125;</span><br><span class="line">p = lambda &#123; <span class="params">|x|</span> x + <span class="number">1</span> &#125;</span><br></pre></td></tr></table></figure>
<p>我們可以把 block 包成 lambda 或者 proc 傳給 method 當作參數，要這樣做需要把它放在最後一個參數，而且前面要以 <code>&amp;</code> 開頭</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">math</span><span class="params">(a, b)</span></span></span><br><span class="line">  <span class="keyword">yield</span>(a, b)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_math</span><span class="params">(a, b, &amp;operation)</span></span> <span class="comment"># &amp; 把 block 變成 procs</span></span><br><span class="line">  math(a, b, &amp;operation)   <span class="comment"># &amp; 把 proc 變成 block</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">do_math(<span class="number">2</span>, <span class="number">3</span>) &#123; <span class="params">|x, y|</span> x * y &#125;</span><br></pre></td></tr></table></figure>
<h2>proc vs lambda</h2>
<p>如果去問 proc 跟 lambda 的 class 都會得到 proc</p>
<p>但我們可以用 <code>lambda?</code> 這個 method 知道他是哪一種</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">inc = Proc.new &#123; <span class="params">|x|</span> x + <span class="number">1</span> &#125;</span><br><span class="line">p = -&gt;(x) &#123; x + <span class="number">1</span> &#125;</span><br><span class="line"></span><br><span class="line">inc<span class="class">.<span class="keyword">class</span> <span class="comment"># Proc</span></span></span><br><span class="line">p<span class="class">.<span class="keyword">class</span>   <span class="comment"># Proc</span></span></span><br><span class="line">inc.lambda? <span class="comment"># false</span></span><br><span class="line">p.lambda?   <span class="comment"># true</span></span><br></pre></td></tr></table></figure>
<p>他們的差異主要有兩點： 1. 參數數量 2. return 效果</p>
<p>以結論來說，lambda 跟 method 有比較接近的性質，而實際上用 <code>to_proc</code> 把 method 變成 proc 也的確是 lambda</p>
<ul>
<li>return 效果</li>
</ul>
<p>lambda 會從這個 lambda 中跳出來，但 proc 則是從定義 proc 的地方整個跳出來</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">a_method</span></span></span><br><span class="line">  p = -&gt;(x) &#123; <span class="keyword">return</span> x + <span class="number">1</span> &#125;</span><br><span class="line">  tmp = p.call(<span class="number">2</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="number">10</span> + tmp</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">a_method <span class="comment"># 13</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">b_method</span></span></span><br><span class="line">  p = proc &#123; <span class="params">|x|</span> <span class="keyword">return</span> x + <span class="number">1</span> &#125;</span><br><span class="line">  tmp = p.call(<span class="number">2</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="number">10</span> + tmp  <span class="comment"># 這裏的 code 不會被執行到</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">a_method <span class="comment"># 3</span></span><br></pre></td></tr></table></figure>
<p>如果定義 proc 的地方在 scope 外面則會發生 error</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">a_method</span><span class="params">(callable)</span></span></span><br><span class="line">  x = <span class="number">2</span></span><br><span class="line">  p = callable.call(<span class="number">2</span>)</span><br><span class="line">  x = <span class="number">2</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">p = -&gt;(x) &#123; <span class="keyword">return</span> x + <span class="number">1</span> &#125;</span><br><span class="line">a_method(p) <span class="comment"># 2</span></span><br><span class="line"></span><br><span class="line">p2 = proc &#123; <span class="params">|x|</span> <span class="keyword">return</span> x + <span class="number">1</span> &#125;</span><br><span class="line">a_method(p2) <span class="comment"># LocalJumpErrors</span></span><br></pre></td></tr></table></figure>
<p>而 proc 的這個特性也可以在一般的 block 裡面看到</p>
<ul>
<li>參數數量</li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">p1 = -&gt;(x) &#123; [<span class="number">1</span>, x] &#125;</span><br><span class="line">p2 = proc &#123; <span class="params">|x|</span> [<span class="number">1</span>, x] &#125;</span><br><span class="line"></span><br><span class="line">p1.call <span class="comment"># ArgumentError</span></span><br><span class="line">p2.call <span class="comment"># [1, nil]</span></span><br><span class="line">p1.call(<span class="number">1</span>,<span class="number">2</span>) <span class="comment"># ArgumentError</span></span><br><span class="line">p2.call(<span class="number">1</span>,<span class="number">2</span>) <span class="comment"># [1, 2]</span></span><br></pre></td></tr></table></figure>
<h2>DSL</h2>
<p>有了 proc，我們差不多可以做出自己的 DSL 了</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">event</span><span class="params">(description)</span></span></span><br><span class="line">  puts <span class="string">"Alert: <span class="subst">#&#123;description&#125;</span>"</span> <span class="keyword">if</span> <span class="keyword">yield</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>這樣的 function 可以這樣用，因為他是在扁平作用域裡面執行，不管是 method 或者 local variable 都可以拿到</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#event.rb</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">monthly_sales</span></span></span><br><span class="line">  <span class="number">110</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">target_sales = <span class="number">100</span></span><br><span class="line"></span><br><span class="line">event <span class="string">"monthly sales are higher than predict"</span> <span class="keyword">do</span></span><br><span class="line">  monthly_sales &gt; target_sales</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">event <span class="string">"monthly sales are lower than predict"</span> <span class="keyword">do</span></span><br><span class="line">  monthly_sales &lt; target_sales</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">&gt; ruby event.rb</span><br><span class="line"><span class="string">"Alert: monthly sales are higher than predict"</span></span><br></pre></td></tr></table></figure>
<p>今天如果需要一個 setup 方法，執行每次的 event 都要先經過 setup method 才行：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># events.rb</span></span><br><span class="line">setup <span class="keyword">do</span></span><br><span class="line">  puts <span class="string">'setting up sky'</span></span><br><span class="line">  @sky_hight = <span class="number">100</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">setup <span class="keyword">do</span></span><br><span class="line">  puts <span class="string">'setting up mountains'</span></span><br><span class="line">  @mountains_hight = <span class="number">200</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">event <span class="string">"the sky is falling"</span> <span class="keyword">do</span></span><br><span class="line">  @sky_height &lt; <span class="number">300</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">event <span class="string">"it's getting closer"</span> <span class="keyword">do</span></span><br><span class="line">  @sky_height &lt; @mountains_height</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">event <span class="string">"too late"</span> <span class="keyword">do</span></span><br><span class="line">  @sky_height &lt; <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 預期的結果</span></span><br><span class="line"><span class="string">'setting up sky'</span></span><br><span class="line"><span class="string">'setting up mountains'</span></span><br><span class="line"><span class="string">"Alert: the sky is falling"</span></span><br><span class="line"><span class="string">'setting up sky'</span></span><br><span class="line"><span class="string">'setting up mountains'</span></span><br><span class="line"><span class="string">"Alert: it's getting closer"</span></span><br><span class="line"><span class="string">'setting up sky'</span></span><br><span class="line"><span class="string">'setting up mountains'</span></span><br></pre></td></tr></table></figure>
<p>這樣的話要怎麼設計呢？</p>
<p>首先因為 setup 裡面的東西一定要晚一點才執行，所以要先把他存起來，event 也是差不多意思</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setup</span><span class="params">(&amp;block)</span></span></span><br><span class="line">  @steups &lt;&lt; block</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">event</span><span class="params">(description, &amp;block)</span></span></span><br><span class="line">  @events &lt;&lt; &#123; <span class="symbol">description:</span> description, <span class="symbol">condition:</span> block &#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">load <span class="string">'events.rb'</span></span><br><span class="line"></span><br><span class="line">@events.each <span class="keyword">do</span> <span class="params">|event|</span></span><br><span class="line">  @setups.each <span class="keyword">do</span> <span class="params">|setup|</span></span><br><span class="line">    setup.calls</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  puts <span class="string">"ALERT: <span class="subst">#&#123;event[<span class="symbol">:desccription</span>]&#125;</span>"</span> <span class="keyword">if</span> event[<span class="symbol">:condition</span>].call</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>這樣的 code 其實還可以利用前面講的扁平作用域把 instance variable 消除</p>
<p>還有一個之前提到的概念，在 block 裡面使用的 local variable 在外面是拿不到的</p>
<p>結合他們，可以寫出這樣的 code:</p>
<p>其中 lambda 存在的意義就是把 <code>setups</code> 跟 events 這兩個變數只能被裡面四個 method 看見</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">lambda &#123;</span><br><span class="line">  setups = []</span><br><span class="line">  events = []</span><br><span class="line">  Kernal.send <span class="symbol">:define_method</span>, <span class="symbol">:setup</span> <span class="keyword">do</span> <span class="params">|&amp;block|</span></span><br><span class="line">    setups &lt;&lt; block</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  Kernal.send <span class="symbol">:define_method</span>, <span class="symbol">:events</span> <span class="keyword">do</span> <span class="params">|&amp;block|</span></span><br><span class="line">    events &lt;&lt; block</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  Kernal.send <span class="symbol">:define_method</span>, <span class="symbol">:each_setup</span> <span class="keyword">do</span> <span class="params">|&amp;block|</span></span><br><span class="line">    setups.each <span class="keyword">do</span> <span class="params">|setup|</span></span><br><span class="line">      block.call setup</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  Kernal.send <span class="symbol">:define_method</span>, <span class="symbol">:each_event</span> <span class="keyword">do</span> <span class="params">|&amp;block|</span></span><br><span class="line">    events.each <span class="keyword">do</span> <span class="params">|event|</span></span><br><span class="line">      block.call event</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">&#125;.call</span><br><span class="line"></span><br><span class="line">load <span class="string">'events.rb'</span></span><br><span class="line"></span><br><span class="line">each_event <span class="keyword">do</span> <span class="params">|event|</span></span><br><span class="line">  each_setup <span class="keyword">do</span> <span class="params">|setup|</span></span><br><span class="line">    setup.call</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  puts <span class="string">"ALERT: <span class="subst">#&#123;event[<span class="symbol">:desccription</span>]&#125;</span>"</span> <span class="keyword">if</span> event[<span class="symbol">:condition</span>].call</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>但現在如果每個 event 裡面各自有 instance varaible，他是會被其他 event 污染的</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">event <span class="string">'A'</span> <span class="keyword">do</span></span><br><span class="line">  @x = <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">event <span class="string">'B'</span> <span class="keyword">do</span></span><br><span class="line">  @x = @x + <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>如果要避免這個情況，有一個 clean room 的技巧可以用，把同一個 event 裡面的 setup 跟 event 都在同一個環境執行，但這個環境需要夠乾淨，我們把 Object 當作乾淨的環境來使用</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">each_event <span class="keyword">do</span> <span class="params">|event|</span></span><br><span class="line">  env = Object.new</span><br><span class="line">  each_setup <span class="keyword">do</span> <span class="params">|setup|</span></span><br><span class="line">    env.instance_eval &amp;setup</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  puts <span class="string">"ALERT: <span class="subst">#&#123;event[<span class="symbol">:desccription</span>]&#125;</span>"</span> <span class="keyword">if</span> env.instance_eval &amp;(event[<span class="symbol">:condition</span>])</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<hr>
<h1>Ch4 Class definition</h1>
<p>在 C 裡面，寫一個 class，像在簽合約，約定說這個 class 要長怎麼樣，但在實際使用這個 class 之前什麼事都不會發生</p>
<p>但 ruby 的 class 裡面實際上就是在執行 code</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClassA</span></span></span><br><span class="line">  puts <span class="string">'test'</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment"># 'test'</span></span><br><span class="line"></span><br><span class="line">b = <span class="class"><span class="keyword">class</span> <span class="title">ClassB</span></span></span><br><span class="line">  <span class="string">'string in class B'</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">b <span class="comment"># 'string in class B'</span></span><br></pre></td></tr></table></figure>
<h2>current class</h2>
<p>就像是不管哪裡都會有一個 self 存在，在所有地方總是會有一個 current class (或者 current module) 存在</p>
<p>但不像是 self 這個 method，並沒有一個方法可以拿到 current class</p>
<p>用 <code>def</code> 定義一個方法的時候，那個方法會變成 current class 的 instance methods</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">m1</span></span></span><br><span class="line">    puts <span class="keyword">self</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">m2</span></span></span><br><span class="line">      puts <span class="string">'test'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> &lt; C</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">&gt; obj = D.new</span><br><span class="line">&gt; D.instance_methods(<span class="literal">false</span>)</span><br><span class="line">[]</span><br><span class="line">&gt; C.instance_methods(<span class="literal">false</span>)</span><br><span class="line">[<span class="symbol">:m1</span>]</span><br><span class="line">&gt; obj.m1</span><br><span class="line"><span class="comment">#&lt;D:0x00007fcffed46f68&gt;</span></span><br><span class="line"> =&gt; <span class="symbol">:m2</span></span><br><span class="line">&gt; D.instance_methods(<span class="literal">false</span>)</span><br><span class="line">[]</span><br><span class="line">&gt; C.instance_methods(<span class="literal">false</span>)</span><br><span class="line">[<span class="symbol">:m1</span>, <span class="symbol">:m2</span>]</span><br></pre></td></tr></table></figure>
<p>可以看到 current class 是跟著 code 跑的，就算我們是用 D 的 object 去 call m1 method，m2 還是定義在 C 身上</p>
<p>之前提到可以用 class 去做 open class，但當我們連 class 的名字都還不知道的時候，我們可以用 <code>class_eval</code> 來做 open class</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_method_to</span><span class="params">(a_class)</span></span></span><br><span class="line">  a_class.class_eval <span class="keyword">do</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">a_method</span>;</span> <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>跟前面的 instance_eval 比較起來，instance_eval 是改變 <code>self</code>，而 class_eval 除了改變 self 之外還改變了 current_class</p>
<p>class_eval 的使用比 class 這個關鍵字靈活很多，class 後面只能放 constant，但 class_eval 的 receiver 可以是代表 class 的變數，而且後面是接 block，代表他也有扁平作用域的特性</p>
<p>其實 class_eval 跟 instance_eval 有些情況下可以互換，比方說你只想要改變 self 的這個功能的時候，但這時候使用 instance_eval 語意上會比較適合</p>
<h2>動態定義 class</h2>
<p>我們可以透過下面的方式做一個匿名的 class</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">c = Class.new(Array) <span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">my_method</span></span></span><br><span class="line">    <span class="string">'Hello!'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">c.name <span class="comment"># nil</span></span><br></pre></td></tr></table></figure>
<p>特別的是，當我們把這個 class assign 給一個 constant，ruby 背後有做一個手腳，讓他知道這個 class 的名字等於這個 constant</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MyClass = c</span><br><span class="line">c.name <span class="comment"># MyClass</span></span><br></pre></td></tr></table></figure>
<h2>Singleton method</h2>
<p>Singleton method 代表只對單一個對象生效的方法</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">str = <span class="string">'string'</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str</span>.<span class="title">title?</span></span></span><br><span class="line">  <span class="keyword">self</span>.upcase == <span class="keyword">self</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">str.title?          <span class="comment"># false</span></span><br><span class="line"><span class="string">'new_string'</span>.title? <span class="comment"># NoMethodError</span></span><br></pre></td></tr></table></figure>
<p>其實 class method 就是 singleton method 的其中一種應用</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">method1</span></span></span><br><span class="line">    <span class="string">'method1'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">MyClass.singleton_methods</span><br><span class="line">&gt; [<span class="symbol">:method1</span>, <span class="symbol">:try_convert</span>, <span class="symbol">:[]</span>]</span><br></pre></td></tr></table></figure>
<h2>Class macro</h2>
<p>有一類方法，他們看起來像關鍵字，但實際上只是 method，他們叫做 class macro，像是 <code>attr_reader</code> 就是一個例子</p>
<p>我們可以做出自己的 class macro:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">deprecate</span><span class="params">(old_method, new_method)</span></span></span><br><span class="line">    define_method(old_method) <span class="keyword">do</span> <span class="params">|*args, &amp;block|</span></span><br><span class="line">      warn <span class="string">"Warning: <span class="subst">#&#123;old_method&#125;</span> is deprecated. Use <span class="subst">#&#123;mew_method&#125;</span>"</span></span><br><span class="line">      send(new_method, *args, &amp;blocks)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  deprecate <span class="symbol">:LENT_TO_USER</span>, <span class="symbol">:lend_to</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">b = Book.new</span><br><span class="line">b.LEND_TO_USER(<span class="string">"Bill"</span>)</span><br><span class="line"><span class="comment"># Warning: LENT_TO_USER is deprecated. Use lend_to</span></span><br></pre></td></tr></table></figure>
<h2>把 singleton class 加到 ancestors chain</h2>
<p>如果用之前看到的 ancestors chain，我們會發現裡面沒有地方可以看到 singleton method 放的地方</p>
<p>obj 本身不放方法，但 class 裡面又不會放 singleton method</p>
<p>這是侯就會知道 singleton class 也是一種 class，他裡面就是放 singleton method</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">method1</span></span></span><br><span class="line">    <span class="string">'method1'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">obj = MyClass.new</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">obj</span>.<span class="title">sing_method</span></span></span><br><span class="line">  <span class="string">'sing_method'</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">&gt; obj.singleton_class.instance_methods(<span class="literal">false</span>)</span><br><span class="line">[<span class="symbol">:sing_method</span>]</span><br><span class="line">&gt; obj<span class="class">.<span class="keyword">class</span>.<span class="title">instance_methods</span>(<span class="title">false</span>)</span></span><br><span class="line">[<span class="symbol">:method1</span>]</span><br><span class="line">&gt; obj.singleton_class.superclass</span><br><span class="line">MyClass</span><br></pre></td></tr></table></figure>
<p>從上面可以看到 singleton class 會繼承 obj 原本的 class</p>
<p>另外要看一下 class 這邊的 singleton class</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> &lt;&lt; self</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">a_class_method</span></span></span><br><span class="line">      <span class="string">'C class_method'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> &lt; C</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">&gt; C.singleton_class</span><br><span class="line"><span class="comment">#&lt;Class:C&gt;</span></span><br><span class="line">&gt; D.singleton_class</span><br><span class="line"><span class="comment">#&lt;Class:D&gt;</span></span><br><span class="line">&gt; D.singleton_class.superclass</span><br><span class="line"><span class="comment">#&lt;Class:C&gt;</span></span><br><span class="line">&gt; C.singleton_class.superclass</span><br><span class="line"><span class="comment">#&lt;Class:Object&gt;</span></span><br><span class="line">&gt; BasicObject.singleton_class.superclass</span><br><span class="line"><span class="comment"># Class</span></span><br></pre></td></tr></table></figure>
<p>從上面的兩個例子可以歸納出：一個 object 的 singleton_class 的 superclass 是這個 object 的 class，一個 class 的 singleton_class 的 superclass 是這個 class 的 superclass 的 singleton class</p>
<p>所以修正過後的 ancestors chain 應該要像是這樣：<br>
<img src="https://i.imgur.com/bZsL9rA.png" alt="ancestors-chain-with-singleton-class"></p>
<p>裡面的 s 代表 super class，c 代表真正的 class，真正的 class 不一定是 <code>class</code> 這個 method 回傳的值</p>
<p>所以一個 object 在找尋 method 的時候，會先向右一步找 singleton class，然後在往上進入 ancestors chain</p>
<h2>instance_eval</h2>
<p>前面說 instance_eval 不會改變 current_class 其實是錯的</p>
<p>他會把當前的 current_class 改成 receiver 的 singleton class</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">s1, s2 = <span class="string">'abc'</span>, <span class="string">'def'</span></span><br><span class="line">s1.instance_eval <span class="keyword">do</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">swoosh!</span>;</span> reverse; <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">s1.swoosh! <span class="comment"># cba</span></span><br><span class="line">s2.swoosh! <span class="comment"># Error</span></span><br></pre></td></tr></table></figure>
<h2>singleton method 應用</h2>
<p>我們都知道 attr_accessor 是用在產生 obj 身上的 method</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line">  <span class="keyword">attr_accessor</span> <span class="symbol">:a</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">obj = MyClass.new</span><br><span class="line">obj.a = <span class="number">2</span></span><br><span class="line">obj.a <span class="comment"># 2</span></span><br></pre></td></tr></table></figure>
<p>那如果我們想給 MyClass 也可以存取自己身上的屬性呢？</p>
<p>因為 MyClass 的 class 是 Class，所以這樣做可以：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Class</span></span></span><br><span class="line">  <span class="keyword">attr_accessor</span> <span class="symbol">:b</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">MyClass.b = <span class="number">3</span></span><br><span class="line">MyClass.b <span class="comment"># 3</span></span><br></pre></td></tr></table></figure>
<p>但這樣會讓所有Class 身上都有 b 這個屬性</p>
<p>如果希望只加在 MyClass 身上，應該放在他自己的 singleton class 身上</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Class</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> &lt;&lt; self</span></span><br><span class="line">    <span class="keyword">attr_accessor</span> <span class="symbol">:c</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">MyClass.c = <span class="number">3</span></span><br><span class="line">MyClass.c <span class="comment"># 3</span></span><br></pre></td></tr></table></figure>
<h2>define class in module</h2>
<p>常常在寫 ruby 的時候，想要把 class method 抽到 module 裡面會這樣寫：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">MyModule</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">my_method</span></span></span><br><span class="line">    <span class="string">'hello'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line">  <span class="keyword">include</span> MyModule</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">MyClass.my_method <span class="comment"># Error</span></span><br></pre></td></tr></table></figure>
<p>因為這樣做會把 my_method 定義在 MyModule 的 Singleton class 裡面</p>
<p>而 include 拿到的是裡面的 instance method，不是 class method</p>
<p>正確的做法是在 module 裡面同樣使用 instance method，但在 class 那邊以 singleton class 來 include</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> &lt;&lt; self</span></span><br><span class="line">    <span class="keyword">include</span> MyModule</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">MyClass.my_method <span class="comment"># hello</span></span><br></pre></td></tr></table></figure>
<p>其實我們連一個普通的 object 也是可以去 include module 使用裡面的方法</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">obj = Object.new</span><br><span class="line"><span class="class"><span class="keyword">class</span> &lt;&lt; obj</span></span><br><span class="line">  <span class="keyword">include</span> MyModule</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">obj.my_method <span class="comment"># hello</span></span><br></pre></td></tr></table></figure>
<p>因為使用 module 裡面的 method 當作 class method 太常見了，所以 Ruby 有一個 <code>extend</code> 方法專門用來做這件事情</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line">  extend MyModule</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h2>Around alias</h2>
<p>around alias 是一種小技巧，通常是用來改變某個 library 裡面的 method 變成你想要的</p>
<p>做的步驟分別是</p>
<ol>
<li>給原本的方法定義一個別名</li>
<li>重新定義這個方法</li>
<li>在新的方法裡面使用舊的方法</li>
</ol>
<p>比方說 Thor 這個 gem 裡面有一段 code 取代了原本的 <code>require</code> 方法</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Kernel</span></span></span><br><span class="line">  alias_method <span class="symbol">:require_without_record</span>, <span class="symbol">:require</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">require</span><span class="params">(file)</span></span></span><br><span class="line">    $requires &lt;&lt; file <span class="keyword">if</span> caller[<span class="number">1</span>] =~ <span class="regexp">/rake2thor:/</span></span><br><span class="line">    require_without_record file</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>他做的步驟分別是把原本的 <code>require</code> 方法改成 <code>require_without_record</code> 這個名字，去改寫 <code>require</code> 這個方法，最後再 call 原本的方法</p>
<h2>prepend</h2>
<p>除了用 around alias 之外，還可以用 prepend</p>
<p>使用 prepend 的話，因為 ancestors chain 會在原本的 class 下面，所以使用 super 就可以 call 原本的 method</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">ExplicitString</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">length</span></span></span><br><span class="line">    <span class="keyword">super</span> &gt; <span class="number">5</span> ? <span class="string">'long'</span> : <span class="string">'short'</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">String.class_eval <span class="keyword">do</span></span><br><span class="line">  prepend ExplicitString</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="string">'War and Peace'</span>.length <span class="comment"># 'long'</span></span><br></pre></td></tr></table></figure>
<hr>
<h1>ch5 Code That Writes code</h1>
<p>在寫之前，我們要了解一下 <code>eval</code> 跟 hook_methods 怎麼使用</p>
<h2>eval</h2>
<p>eval 這個方法不像 <code>instance_eval</code> 跟 <code>class_eval</code> 後面可以使用 block 來執行，他會吃一段包含 ruby code 的 string，直接執行 string 的內容，這段 string 可以稱作 string of code</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">array = [<span class="number">10</span>, <span class="number">20</span>]</span><br><span class="line">element = <span class="number">30</span></span><br><span class="line">eval <span class="string">"array &lt;&lt; element"</span> <span class="comment"># [10, 20, 30]</span></span><br></pre></td></tr></table></figure>
<p>eval 可以配合 binding object使用，binding object 可以視為比 block 更為乾淨的 closure，他只包含 scope 而不包含 code 內容</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">my_method</span></span></span><br><span class="line">    @x = <span class="number">1</span></span><br><span class="line">    binding</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">b = MyClass.new.my_method</span><br><span class="line">eval(<span class="string">"@x"</span>, b) <span class="comment"># 1</span></span><br></pre></td></tr></table></figure>
<p>然後 ruby 有一個 <code>TOPLEVEL_BINDING</code> 的 constant，用來表示 top level scope 的 binding object</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnotherClass</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">my_method</span></span></span><br><span class="line">    eval <span class="string">"self"</span>, TOPLEVEL_BINDING</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">AnotherClass.new.my_method <span class="comment"># main</span></span><br></pre></td></tr></table></figure>
<p>string of code 跟 block 滿類似的，那到底什麼時候要用什麼呢？</p>
<p>A: 能用 block 就盡量用 block，因為 string of code 難以閱讀跟修改，加上 ruby 在執行到 string of code 之前不會對他做語法檢查，容易導致意想不到的錯誤，但最大的問題還是在 code injection attack(類似 sql injection)</p>
<p>但還是有比較安全的使用 <code>eval</code> 的方式，那就是搭配 ruby 的 safe level 跟 tainted object</p>
<p>Ruby 原本就預設會把從外部傳進來的 object 標記為 tainted object，其中包括文件 / command line 輸入的內容 / 甚至 env var 等等</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ENV[<span class="string">'test'</span>]=<span class="string">'test'</span></span><br><span class="line">ENV[<span class="string">'test'</span>].tainted? <span class="comment"># true</span></span><br></pre></td></tr></table></figure>
<p>safe level 有從 0 ~ 3 的 4 個 level，只要 safe level 在 1 以上，系統都會拒絕執行 tainted object 的內容，就可以避免 code injection</p>
<p>要看現在的 safe level 可以用 <code>$SAFE</code> 這個全域變數來看，然後我們如果確定某個 object 是安全的，可以用 <code>untainted</code> 方法來取消這個屬性</p>
<p>像是 ERB 裡面，就有這樣的方式</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ERB</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">result</span><span class="params">(b=new_toplevel)</span></span></span><br><span class="line">    <span class="keyword">if</span> @safe_level</span><br><span class="line">      proc &#123;</span><br><span class="line">        $SAFE = @safe_level</span><br><span class="line">        eval(@src, b, (@filename <span class="params">||</span> <span class="string">'(erb)'</span>, <span class="number">0</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      eval(@src, b, (@filename <span class="params">||</span> <span class="string">'(erb)'</span>, <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p><code>new_toplevel</code> 是 TOPLEVEL_BINDING 的一份 copy</p>
<p><code>@src</code> 就是 ERB template 中的一段 code 內容 ex. <code>&lt;% code %&gt;</code></p>
<p>這段 code 的意思是，如果有設定的 safe level(<code>@safe_level</code>)，那就會用 proc 開一個 sandbox 環境去執行，其中那個新的 safe level 只在 proc 裡面有用，如果沒有設定 safe level 就會直接執行 code 內容</p>
<h2>Hook methods</h2>
<p>hook methods 可以用來抓取某個事件，在他發生的時候做事情，像是下面這個例子</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">String</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">inherited</span><span class="params">(subclass)</span></span></span><br><span class="line">    puts <span class="string">"<span class="subst">#&#123;<span class="keyword">self</span>&#125;</span> was inherited by <span class="subst">#&#123;subclass&#125;</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyString</span> &lt; String</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment"># String was inherited by MyString</span></span><br></pre></td></tr></table></figure>
<p>類似的還有 <code>included</code> / <code>prepended</code> / <code>method_added</code> 等方法</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">M1</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">included</span><span class="params">(othermod)</span></span></span><br><span class="line">    puts <span class="string">"M1 was included into <span class="subst">#&#123;othermod&#125;</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">method_added</span><span class="params">(method)</span></span></span><br><span class="line">    puts <span class="string">"New method: M#<span class="subst">#&#123;method&#125;</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>如果是針對 singleton_method，則可以用 <code>singleton_method_added</code> <code>singleton_method_removed</code> 等方法</p>
<p>當然我們也可以反向操作，改成改主動方的方法：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">include</span><span class="params">(*modules)</span></span></span><br><span class="line">    puts <span class="string">"Called: C.include(<span class="subst">#&#123;modules&#125;</span>)"</span></span><br><span class="line">    <span class="keyword">super</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">include</span> M</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment"># Called: C.include(M)</span></span><br></pre></td></tr></table></figure>
<p>前面提過 include 一個 module，只會拿到他裡面的 instance methods，但 VCR 就有一個 module <code>Nomalizers::Body</code>，只要 include 他，裡面的 method 就會變成這個 class 的 class_methods，來看看他是怎麼做到的：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">VCR</span></span></span><br><span class="line">  <span class="class"><span class="keyword">module</span> <span class="title">Nomalizers</span></span></span><br><span class="line">    <span class="class"><span class="keyword">module</span> <span class="title">Body</span></span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">included</span><span class="params">(klass)</span></span></span><br><span class="line">        klass.extend ClassMethods</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">      <span class="class"><span class="keyword">module</span> <span class="title">ClassMethods</span></span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">body_from</span><span class="params">(hash_or_string)</span></span></span><br><span class="line">          ...</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>所以如果有一個 <code>Request</code> 的 class include 了這個 module，就會 trigger <code>included</code> method，<code>Request</code> 會去 extend <code>ClassMethods</code> 這個 module，因此會新增一系列的 class methods</p>
<h2>實作</h2>
<p>現在來嘗試使用前面提過的技巧來做 metaprogramming</p>
<p>如果今天要寫出一個 class macro <code>attr_checked</code>，而他的使用法方式很像 attr_accesor，但會額外加上檢查的機制</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line">  <span class="keyword">include</span> CheckedAttributes</span><br><span class="line"></span><br><span class="line">  attr_checked <span class="symbol">:age</span> <span class="keyword">do</span> <span class="params">|v|</span></span><br><span class="line">    v &gt;= <span class="number">18</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">m = Person.new</span><br><span class="line">m.age = <span class="number">39</span></span><br><span class="line">m.age <span class="comment"># 39</span></span><br><span class="line">m.age = <span class="number">17</span> <span class="comment"># Error</span></span><br></pre></td></tr></table></figure>
<p>我們可以透過下面步驟來嘗試開發：</p>
<ol>
<li>使用 eval 方法，寫出一個 <code>add_checked_attribute</code>，如果把 class 跟 attribute 丟進去，會在這個 class 上面動態做出方法</li>
<li>重構 <code>add_checked_attribute</code> 方法，把 <code>eval</code> 拿掉</li>
<li>加上檢查 block 條件的機制</li>
<li>把 <code>add_checked_attribute</code> 改成 <code>attr_checked</code>，先改成對所有 class 都有用</li>
<li>包裝在一個 module 裡面，只對 include 這個 module 的 class 動態產生方法</li>
</ol>
<h3>Step1</h3>
<p>第一階段，我們嘗試直接使用 eval 實作 open class，這樣會比較直觀</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_checked_attribute</span><span class="params">(klass, attribute)</span></span></span><br><span class="line">  eval <span class="string">"</span></span><br><span class="line"><span class="string">    class <span class="subst">#&#123;klass&#125;</span></span></span><br><span class="line"><span class="string">      def <span class="subst">#&#123;attribute&#125;</span>=(value)</span></span><br><span class="line"><span class="string">        raise 'Invalid attribute' unless value</span></span><br><span class="line"><span class="string">        @<span class="subst">#&#123;attribute&#125;</span> = value</span></span><br><span class="line"><span class="string">      end</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">      def <span class="subst">#&#123;attribute&#125;</span></span></span><br><span class="line"><span class="string">        @<span class="subst">#&#123;attribute&#125;</span></span></span><br><span class="line"><span class="string">      end</span></span><br><span class="line"><span class="string">    end</span></span><br><span class="line"><span class="string">  "</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3>Step2</h3>
<p>第二階段，我們要把 eval 拿掉，為了打開 class 的 scope，可以用 class_eval 來做</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_checked_attribute</span><span class="params">(klass, attribute)</span></span></span><br><span class="line">  klass.class_eval <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># current_class 已經變成 klass</span></span><br><span class="line">    <span class="comment"># self 也變成 klasss</span></span><br><span class="line">    define_method <span class="string">"<span class="subst">#&#123;attribute&#125;</span>="</span> <span class="keyword">do</span> <span class="params">|value|</span></span><br><span class="line">      raise <span class="string">'Invalid attribute'</span> <span class="keyword">unless</span> value</span><br><span class="line">      instance_variable_set(<span class="string">"@<span class="subst">#&#123;attribute&#125;</span>"</span>, value)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    define_method <span class="string">"<span class="subst">#&#123;attribute&#125;</span>"</span></span><br><span class="line">      instance_variable_set(<span class="string">"@<span class="subst">#&#123;attribute&#125;</span>"</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3>Step3</h3>
<p>目前我們只實作了類似 <code>attr_accesor</code> 的功能，但接著應該在 assign 的 method 上加上檢查的機制</p>
<p>再來回顧一下使用案例：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line">  <span class="keyword">include</span> CheckedAttributes</span><br><span class="line"></span><br><span class="line">  attr_checked <span class="symbol">:age</span> <span class="keyword">do</span> <span class="params">|v|</span></span><br><span class="line">    v &gt;= <span class="number">18</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">m.age = <span class="number">17</span> <span class="comment"># Error</span></span><br></pre></td></tr></table></figure>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_checked_attribute</span><span class="params">(klass, attribute, &amp;block)</span></span></span><br><span class="line">  klass.class_eval <span class="keyword">do</span></span><br><span class="line">    define_method <span class="string">"<span class="subst">#&#123;attribute&#125;</span>="</span> <span class="keyword">do</span> <span class="params">|value|</span></span><br><span class="line">      raise <span class="string">'Invalid attribute'</span> <span class="keyword">unless</span> block.call(value)</span><br><span class="line">      instance_variable_set(<span class="string">"@<span class="subst">#&#123;attribute&#125;</span>"</span>, value)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    define_method <span class="string">"<span class="subst">#&#123;attribute&#125;</span>"</span></span><br><span class="line">      instance_variable_set(<span class="string">"@<span class="subst">#&#123;attribute&#125;</span>"</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3>Step4</h3>
<p>把 <code>add_checked_attribute</code> 改成 <code>checked_attribute</code>，然後對所有 class 都可以使用</p>
<p>因為要讓所有 class 都可以使用這個 class_method，所以是所有 class 的 singleton_method，所有 class 的 singleton_method 最後會找到 Class 身上的 instance_method</p>
<p>然後因為 Class 的 superclass 是 Module，我們其實也可以定義在 Module 身上</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Class</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">checked_attribute</span><span class="params">(attribute, &amp;block)</span></span></span><br><span class="line">    define_method <span class="string">"<span class="subst">#&#123;attribute&#125;</span>="</span> <span class="keyword">do</span> <span class="params">|value|</span></span><br><span class="line">      raise <span class="string">'Invalid attribute'</span> <span class="keyword">unless</span> block.call(value)</span><br><span class="line">      instance_variable_set(<span class="string">"@<span class="subst">#&#123;attribute&#125;</span>"</span>, value)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    define_method <span class="string">"<span class="subst">#&#123;attribute&#125;</span>"</span></span><br><span class="line">      instance_variable_set(<span class="string">"@<span class="subst">#&#123;attribute&#125;</span>"</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3>Step5</h3>
<p>我們要讓他不對所有的 class 產生作用，只作用在 include 了 <code>CheckedAttributes</code> 這個 module 的 class 身上</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">CheckedAttributes</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">included</span><span class="params">(klass)</span></span></span><br><span class="line">    klass.extend ClassMethods</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">module</span> <span class="title">ClassMethods</span></span></span><br><span class="line">    define_method <span class="string">"<span class="subst">#&#123;attribute&#125;</span>="</span> <span class="keyword">do</span> <span class="params">|value|</span></span><br><span class="line">      raise <span class="string">'Invalid attribute'</span> <span class="keyword">unless</span> block.call(value)</span><br><span class="line">      instance_variable_set(<span class="string">"@<span class="subst">#&#123;attribute&#125;</span>"</span>, value)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    define_method <span class="string">"<span class="subst">#&#123;attribute&#125;</span>"</span></span><br><span class="line">      instance_variable_set(<span class="string">"@<span class="subst">#&#123;attribute&#125;</span>"</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<hr>
<h1>Ch6 Rails source code</h1>
<p>在 Rails 裡面用到非常多不同的 gem，我們要看這個 gem 的 source code 可以這樣去把他下載下來</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt; gem unpack activerecord -v=4.1.0</span><br></pre></td></tr></table></figure>
<h2>Concern module</h2>
<p>要了解 concern 這個 module 最好知道為什麼會有這個 module</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">ActiveRecord</span></span></span><br><span class="line">  <span class="class"><span class="keyword">module</span> <span class="title">Validations</span></span></span><br><span class="line">    <span class="comment">#...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">included</span><span class="params">(base)</span></span></span><br><span class="line">      base extend ClassMethods</span><br><span class="line">      <span class="comment">#...</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">module</span> <span class="title">ClassMethods</span></span></span><br><span class="line">      <span class="function"><span class="keyword">def</span> <span class="title">validation_length_of</span><span class="params">(*attrs)</span></span></span><br><span class="line">      <span class="comment">#...</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">valid?</span></span></span><br><span class="line">      <span class="comment">#...</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>透過這樣的方式，include 這個 module 的 class 可以有 <code>validation_length_of</code> 的 class method 跟 <code>valid?</code> 的 instance method</p>
<p>雖然看起來很好用，但他隱藏著一個問題，看下面這個例子：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">SecondLevelModule</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">included</span><span class="params">(base)</span></span></span><br><span class="line">    base.extend ClassMethods</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">second_level_instance_method</span>;</span> <span class="string">'ok'</span>; <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">module</span> <span class="title">ClassMethods</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">second_level_class_method</span>;</span> <span class="string">'ok'</span>; <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">FirstLevelModule</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">included</span><span class="params">(base)</span></span></span><br><span class="line">    base.extend ClassMethods</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">first_level_instance_method</span>;</span> <span class="string">'ok'</span>; <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">module</span> <span class="title">ClassMethods</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">first_level_class_method</span>;</span> <span class="string">'ok'</span>; <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">include</span> SecondLevelModule</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseClass</span></span></span><br><span class="line">  <span class="keyword">include</span> FirstLevelModule</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">BaseClass.new.first_level_instance_method <span class="comment"># ok</span></span><br><span class="line">BaseClass.new.second_level_instance_method <span class="comment"># ok</span></span><br><span class="line">BaseClass.new.first_level_cladd_method <span class="comment"># ok</span></span><br><span class="line">BaseClass.new.second_level_class_method <span class="comment"># Error</span></span><br></pre></td></tr></table></figure>
<p>這是因為在 SecondLevelModule 的 included 裡面，base 不是 BaseClass 而是 FirstLevelModule，所以會變成 FirstLevelModule 的 singleton method</p>
<p>而 Rails2 當初為了解決這問題，解決的不是很漂亮，他是只對第一層的 module 做了這個技巧，然後強迫 include 他的 class 也去 include 第二層的 module</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">FirstLevelModule</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">included</span><span class="params">(base)</span></span></span><br><span class="line">    base.extend ClassMethods</span><br><span class="line">    base.send <span class="symbol">:include</span>, SecondLevelModule</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>但這樣一來，每個 module 必須知道他是不是被當成第一層 module 使用，因此後來才有了 Concern 這個 module</p>
<p>因為 Concern 裡面覆寫了 append_features 這個 method，所以要先提一下 append_features 這個方法</p>
<h3>append_features</h3>
<p>在我們平常 inculde 一個 module 之後，在 call 了 included 之後，會繼續 call append_features 這個 method</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">A</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">included</span><span class="params">(target)</span></span></span><br><span class="line">    v = target.instance_methods.<span class="keyword">include</span>?(<span class="symbol">:method_name</span>)</span><br><span class="line">    puts <span class="string">"in included: <span class="subst">#&#123;v&#125;</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">append_features</span><span class="params">(target)</span></span></span><br><span class="line">    v = target.instance_methods.<span class="keyword">include</span>?(<span class="symbol">:method_name</span>)</span><br><span class="line">    puts <span class="string">"in append features before: <span class="subst">#&#123;v&#125;</span>"</span></span><br><span class="line">    <span class="keyword">super</span></span><br><span class="line">    v = target.instance_methods.<span class="keyword">include</span>?(<span class="symbol">:method_name</span>)</span><br><span class="line">    puts <span class="string">"in append features after: <span class="subst">#&#123;v&#125;</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">method_name</span></span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">X</span></span></span><br><span class="line"> <span class="keyword">include</span> A</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># in append features before: false</span></span><br><span class="line"><span class="comment"># in append features after: true</span></span><br><span class="line"><span class="comment"># in included: true</span></span><br></pre></td></tr></table></figure>
<p>如果去覆寫這個 method，可能會得到讓你吃驚的結果：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">M</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">append_features</span><span class="params">(base)</span></span>; <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">  <span class="keyword">include</span> M</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">C.ancestors <span class="comment"># [C, Object, Kernal, BasicObject]</span></span><br></pre></td></tr></table></figure>
<p>可以知道竟然在 ancestor chain 沒看到 M，而這剛好也是 Concern  想要的結果</p>
<h3>Concern Source code</h3>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">ActiveSupport</span></span></span><br><span class="line">  <span class="class"><span class="keyword">module</span> <span class="title">Concern</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">extended</span><span class="params">(base)</span></span></span><br><span class="line">      base.instance_variable_set(<span class="symbol">:</span>@_dependencies, [])</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">append_features</span><span class="params">(base)</span></span></span><br><span class="line">      <span class="keyword">if</span> base.instance_variable_defined?(<span class="symbol">:</span>@_dependencies)</span><br><span class="line">         base.instance_variable_get(<span class="symbol">:</span>@_dependencies) &lt;&lt; <span class="keyword">self</span></span><br><span class="line">         <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span> <span class="keyword">if</span> base &lt; <span class="keyword">self</span></span><br><span class="line">        @_dependencies.each &#123; <span class="params">|dep|</span> base.send(<span class="symbol">:include</span>, dep) &#125;</span><br><span class="line">        <span class="keyword">super</span></span><br><span class="line">        base.extend const_get(<span class="symbol">:ClassMethods</span>) <span class="keyword">if</span> const_defined?(<span class="symbol">:ClassMethods</span>)</span><br><span class="line">        <span class="comment"># ...</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>我們來嘗試解讀這段 code，如果一個 class 有 include 這個 ActiveRecord::Concern，會在他身上定義 <code>@_dependencies</code> 這個 instance_variable</p>
<p>然後如果要把一個 module 變成 concern，需要 extend 這個 module，因次 append_features 會變成那個 module 的 class_method</p>
<p>而在 append_features 這個 method 裡面，base 是要 include 這個 concern 的 module/class(可能是另一個 concern)，而 self 是那一個被 include 的 concern</p>
<p>所以進入這個 method 後，先用是不是有 <code>@_depnencencies</code> 這個變數來檢查，這個 base 本身是不是也是另一個 concern，如果也是的話，被 include 的這個 module 不會進入 ancestor chain，只是把他加入 dependency 裡面</p>
<p>接著檢查，如果這個要被 include 的 module 已經在 base 的 ancestor chain 裡面，也不去加到 ancestor chain</p>
<p>如果都不是上面的情況，就會把相依的 dependency 都去 include，並且 extend 裡面目前這個 concern 定義的 ClassMethods</p>
<h2>alias_method_chain</h2>
<p>alias_method_chain 是 Rails 內建方法，曾經很多人用，但後來漸漸沒有人使用，可以探討一下為什麼</p>
<p>alias_method_chain 的 source_code:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Module</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">alias_method_chain</span><span class="params">(target, feature)</span></span></span><br><span class="line">    alias_target, punctuation = target.to_s.sub(<span class="regexp">/(?!=)$/</span>, <span class="string">''</span>), $1</span><br><span class="line">    <span class="keyword">yield</span>(aliased_target, punctuation) <span class="keyword">if</span> block_given?</span><br><span class="line"></span><br><span class="line">    with_method = <span class="string">"<span class="subst">#&#123;aliased_target&#125;</span>_with_<span class="subst">#&#123;feature&#125;</span><span class="subst">#&#123;punctuation&#125;</span>"</span></span><br><span class="line">    with_out_method = <span class="string">"<span class="subst">#&#123;aliased_target&#125;</span>_without_<span class="subst">#&#123;feature&#125;</span><span class="subst">#&#123;punctuation&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">    alias_method without_method, target</span><br><span class="line">    alias_method target, with_target</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">case</span></span><br><span class="line">    <span class="keyword">when</span> public_method_defined?(without_method)</span><br><span class="line">      public target</span><br><span class="line">    <span class="keyword">when</span> protected_method_defined?(without_target)</span><br><span class="line">      protected target</span><br><span class="line">    <span class="keyword">when</span> private_method_defined?(without_taget)</span><br><span class="line">      private target</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>target 是需要增強的方法名字，feature 是想要拿來添加的方法的名字</p>
<p>一開始先把 !?= 結尾的方法改掉(因為像是 target?_without_feature 這樣的方法名字是不能用的)</p>
<p>然後會把舊的方法名字改成 target_without_feature</p>
<p>再另外把 target 方法 alias 到 target_with_feature 這個方法</p>
<p>最後 case 的那一段只是把原本的方法屬性套用在新的方法上面</p>
<p>最後要自己手動定義 target_with_feature 這個方法才算是可以用</p>
<p>我們來看看舊版的 ActiveRecord::Validations 的使用方式：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">ActiveRecord</span></span></span><br><span class="line">  <span class="class"><span class="keyword">module</span> <span class="title">Validations</span></span></span><br><span class="line">    <span class="comment">#...</span></span><br><span class="line">    base.class_eval <span class="keyword">do</span></span><br><span class="line">      alias_method_chain <span class="symbol">:save</span>, <span class="symbol">:validations</span></span><br><span class="line">      alias_method_chain <span class="symbol">:save!</span>, <span class="symbol">:validation</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save_with_validation</span></span></span><br><span class="line">      <span class="comment">#...</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">save_with_validation!</span></span></span><br><span class="line">      <span class="comment">#...</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>但很多時候，其實是不需要用到這種技巧的</p>
<p>以下面這個例子來舉例：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Greetings</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">greet</span></span></span><br><span class="line">    <span class="string">"Hello!"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line">  <span class="keyword">include</span> Greetings</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">greet_with_enthusiasm</span></span></span><br><span class="line">    <span class="string">"Hey, <span class="subst">#&#123;greet_without_enthusiasm&#125;</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  alias_method <span class="symbol">:greet_without_enthusiasm</span>, <span class="symbol">:greet</span></span><br><span class="line">  alias_method <span class="symbol">:greet</span>, <span class="symbol">:greete_with_enthusism</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">MyClass.new.greet <span class="comment"># "Hey, Hello!"</span></span><br></pre></td></tr></table></figure>
<p>這裏一樣用到 around alias 的技巧，但其實不需要這麼麻煩</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Greetings</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">greet</span></span></span><br><span class="line">    <span class="string">"Hello!"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">EnthusiasticGreetings</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">greet</span></span></span><br><span class="line">    <span class="string">"Hey, <span class="subst">#&#123;<span class="keyword">super</span>&#125;</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line">  <span class="keyword">include</span> Greetings</span><br><span class="line">  <span class="keyword">include</span> EnthusiasticGreetings</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">MyClass.new.greet <span class="comment"># "Hey, Hello!"</span></span><br></pre></td></tr></table></figure>
<p>因為 Greetings 在 EnthusiasticGreetings ancestors chain 的上面，只要用 super 就可以拿到那個 method</p>
<p>雖然這樣比較不酷但是比較單純</p>
<p>只是以上這個方法不適用在原本的方法就定義在 class 裡面的情況：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line">  <span class="keyword">include</span> EnthusiasticGreetings</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">greet</span></span></span><br><span class="line">    <span class="string">"Hello!"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">EnthusiasticGreetings</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">greet</span></span></span><br><span class="line">    <span class="string">"Hey, <span class="subst">#&#123;<span class="keyword">super</span>&#125;</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">MyClass.new.greet <span class="comment"># Hello!</span></span><br></pre></td></tr></table></figure>
<p>因為方法尋找會先找到 class 本身的 method</p>
<p>不過在 ruby2.0 之後，出現了 prepend 這個 method</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line">  prepend EnthusiasticGreetings</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">greet</span></span></span><br><span class="line">    <span class="string">"Hello!"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">EnthusiasticGreetings</span></span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">greet</span></span></span><br><span class="line">    <span class="string">"Hey, <span class="subst">#&#123;<span class="keyword">super</span>&#125;</span>"</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">MyClass.new.greet <span class="comment"># Hey, Hello!</span></span><br></pre></td></tr></table></figure>
<p>這也是現在越來越少地方有用到 alias_method_chain 這個方法的原因</p>
<hr>
<h2>Evolution of Attribute Methods</h2>
<p>Rails 的 attibute methods 是動態產生的，我們來觀察看看他的演化過程</p>
<p>以下是 Rails1 的版本</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">ActiveRecord</span></span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">Base</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(attributes = <span class="literal">nil</span>)</span></span></span><br><span class="line">      @attributes = attributes_form_column_definition</span><br><span class="line">      <span class="comment"># ...</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">attribute_names</span></span></span><br><span class="line">      @attributes.keys.sort</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    alias_method <span class="symbol">:respond_to_without_attributes?</span>, <span class="symbol">:respond_to?</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">respond_to?</span><span class="params">(method)</span></span></span><br><span class="line">      @@dynamic_methods <span class="params">||</span>= attribute_names +</span><br><span class="line">                            attributes_names.collect &#123; <span class="params">|attr|</span> attr + <span class="string">"="</span> &#125; +</span><br><span class="line">                            attributes_names.collect &#123; <span class="params">|attr|</span> attr + <span class="string">"?"</span> &#125;</span><br><span class="line">      @@dynamic_methods.<span class="keyword">include</span>?(method.to_s) ? <span class="literal">true</span> : respond_to_without_attributes?(method)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">method_missing</span><span class="params">(method_id, *arguments)</span></span></span><br><span class="line">      method_name = method_id.id2name</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> method_name =~ read_method? &amp;&amp; @@attributes.<span class="keyword">include</span>?($1)</span><br><span class="line">        <span class="keyword">return</span> read_attribute($1)</span><br><span class="line">      <span class="keyword">elsif</span> method_name =~ write_method?</span><br><span class="line">        write_attribute($1, arguments[<span class="number">0</span>])</span><br><span class="line">      <span class="keyword">elsif</span> method_name =~ query_method?</span><br><span class="line">        <span class="keyword">return</span> query_attributes($1)</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        supre</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>首先在 initialize 的時候，就會把 attributes 有哪些讀進來</p>
<p>然後用 around alias 的方式把 respond_to? 方法換掉，會偵測所有屬性的名字跟後面帶問號或者等號的方法</p>
<p>如果真的使用到屬性方法，像是 description, description= 或者 description? 這種方法，會進入 method_missing</p>
<p>但上面這種方式，只要每次用到屬性方法，都必須走過完整的 ancestor chain，才會走到 method_missing，因此效能不好</p>
<p>在 Rails2 裡面，結合了 method_missing 跟動態定義方法的機制</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">ActiveRecord</span></span></span><br><span class="line">  <span class="class"><span class="keyword">module</span> <span class="title">AttributeMethods</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">method_missing</span><span class="params">(method_id, *args, &amp;block)</span></span></span><br><span class="line">      method_name = method_id.to_s</span><br><span class="line"></span><br><span class="line">      <span class="comment">#...</span></span><br><span class="line">      <span class="keyword">if</span> !<span class="keyword">self</span><span class="class">.<span class="keyword">class</span>.<span class="title">generated_methods?</span></span></span><br><span class="line">        <span class="keyword">self</span><span class="class">.<span class="keyword">class</span>.<span class="title">define_attribute_methods</span></span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">self</span><span class="class">.<span class="keyword">class</span>.<span class="title">generated_methods</span>.<span class="title">include?</span>(<span class="title">method_name</span>)</span></span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">self</span>.send(method_id, *args, &amp;block)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      <span class="comment">#...</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">define_method_attriubte_methods</span></span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">if</span> generated_methods?</span><br><span class="line">      column_hash.each <span class="keyword">do</span> <span class="params">|name, column|</span></span><br><span class="line">        <span class="keyword">unless</span> instance_already_implemmented?(name)</span><br><span class="line">          <span class="keyword">if</span> <span class="keyword">self</span>.serialized_attributes[name]</span><br><span class="line">            define_read_method_for_serialized_attribute(name)</span><br><span class="line">          <span class="keyword">elsif</span> create_time_zone_conversion_attribute?(name, column)</span><br><span class="line">            define_method_for_time_zone_conversion(name)</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            define_read_method(name.to_sym, name, column)</span><br><span class="line">          <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">unless</span> instance_already_implemmented?(<span class="string">"<span class="subst">#&#123;name&#125;</span>="</span>)</span><br><span class="line">          <span class="comment">#...</span></span><br><span class="line">          define_write_method(name.to_sym)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">unless</span> instance_already_implemmented?(<span class="string">"<span class="subst">#&#123;name&#125;</span>?"</span>)</span><br><span class="line">          <span class="comment">#...</span></span><br><span class="line">          define_question_method(name.to_sym)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>在第一次使用 attribute methods 的時候會跑到上面的 method_missing 裡面，透過 <code>define_attribute_methods</code> 這個方法定義真正的屬性方法，讓他們變成真正有血有肉存在的方法</p>
<p>最後產生真正的方法，會在 define_xxx_method 裡面，我們來看看 define_write_method 這個方法</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">define_write_method</span><span class="params">(attr_name)</span></span></span><br><span class="line">  evaluate_attribute_method attr_name,</span><br><span class="line">    <span class="string">"def <span class="subst">#&#123;attr_name&#125;</span>=(new_value);write_attribute('<span class="subst">#&#123;attr_name&#125;</span>', new_value);end"</span>,</span><br><span class="line">    <span class="string">"<span class="subst">#&#123;attr_name&#125;</span>="</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">evaluate_attribute_method</span><span class="params">(attr_name, method_definition, method_name=attr_name)</span></span></span><br><span class="line">  <span class="comment">#...</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">    class_eval(method_definition, __FILE_<span class="number">_</span>, __LINE_<span class="number">_</span>)</span><br><span class="line">  <span class="keyword">rescue</span></span><br><span class="line">  <span class="comment">#...</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>之後再 Rails3 Rails4 更把這部分做得更加複雜了，主要是針對效率上的改善</p>
<p>從上面的例子可以看到，Rails 的開發過程是漸進式的，畢竟要一次想到完美的解決方案是極為困難的</p>

                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/article/2021-08-20-Elixir_Basics/" data-toggle="tooltip" data-placement="top" title="Elixir Basics">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/article/2021-07-19-CKA_Exam/" data-toggle="tooltip" data-placement="top" title="Tips For Passing Certified Kubernetes Administrator(CKA) Exam">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <br>

                <!--打赏-->
                
                <!--打赏-->

                <br>
                <!--分享-->
                
                <!--分享-->
                <br>                       
                
                <!-- require APlayer -->
                

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->

                <!-- disqus comment start -->
                
                <!-- disqus comment end -->

                

            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

  
    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">Ch1 Object model</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">Open class</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">Constants</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">Ancestors chain / method lookup</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.4.</span> <span class="toc-nav-text">Kernal module</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.5.</span> <span class="toc-nav-text">self</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">1.6.</span> <span class="toc-nav-text">Refine</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">Ch2 Method</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">2.1.</span> <span class="toc-nav-text">send / Dynamic Dispatch</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">2.2.</span> <span class="toc-nav-text">define_method / Dynamic Method</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">2.3.</span> <span class="toc-nav-text">method_missing / Ghost Method / Dynamic Proxy</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">2.4.</span> <span class="toc-nav-text">Blank Slates</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">2.4.1.</span> <span class="toc-nav-text">undef_method / remove_method</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">Ch3 Blocks</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">Blocks are closure</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">scope</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">3.3.</span> <span class="toc-nav-text">instance_eval</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">3.4.</span> <span class="toc-nav-text">Callable Object</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">3.5.</span> <span class="toc-nav-text">proc vs lambda</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">3.6.</span> <span class="toc-nav-text">DSL</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">Ch4 Class definition</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">4.1.</span> <span class="toc-nav-text">current class</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">4.2.</span> <span class="toc-nav-text">動態定義 class</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">4.3.</span> <span class="toc-nav-text">Singleton method</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">4.4.</span> <span class="toc-nav-text">Class macro</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">4.5.</span> <span class="toc-nav-text">把 singleton class 加到 ancestors chain</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">4.6.</span> <span class="toc-nav-text">instance_eval</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">4.7.</span> <span class="toc-nav-text">singleton method 應用</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">4.8.</span> <span class="toc-nav-text">define class in module</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">4.9.</span> <span class="toc-nav-text">Around alias</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">4.10.</span> <span class="toc-nav-text">prepend</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">ch5 Code That Writes code</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">5.1.</span> <span class="toc-nav-text">eval</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">5.2.</span> <span class="toc-nav-text">Hook methods</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">5.3.</span> <span class="toc-nav-text">實作</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">5.3.1.</span> <span class="toc-nav-text">Step1</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">5.3.2.</span> <span class="toc-nav-text">Step2</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">5.3.3.</span> <span class="toc-nav-text">Step3</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">5.3.4.</span> <span class="toc-nav-text">Step4</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">5.3.5.</span> <span class="toc-nav-text">Step5</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">Ch6 Rails source code</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">6.1.</span> <span class="toc-nav-text">Concern module</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">6.1.1.</span> <span class="toc-nav-text">append_features</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">6.1.2.</span> <span class="toc-nav-text">Concern Source code</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">6.2.</span> <span class="toc-nav-text">alias_method_chain</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#null"><span class="toc-nav-number">6.3.</span> <span class="toc-nav-text">Evolution of Attribute Methods</span></a></li></ol></li></ol>
        
        </div>
      </aside>
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#Ruby" title="Ruby">Ruby</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://riverye.com" target="_blank">小菜</a></li>
                    
                        <li><a href="https://chaichai.site" target="_blank">柴柴</a></li>
                    
                        <li><a href="https://louiswuyj.site" target="_blank">Louis</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>








<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>


<!-- chrome Firefox 中文锚点定位失效-->
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.js"></script>
<!-- smooth scroll behavior polyfill  -->
<script type="text/javascript" src="/js/smoothscroll.js"></script>
<script>
        $('#toc').on('click','a',function(a){
            // var isChrome = window.navigator.userAgent.indexOf("Chrome") !== -1;
            // console.log(window.navigator.userAgent,isChrome)
                // if(isChrome) {
                    // console.log(a.currentTarget.outerHTML);
                    // console.log($(a.currentTarget).attr("href"));
                    //跳转到指定锚点
                    // document.getElementById(a.target.innerText.toLowerCase()).scrollIntoView(true);
                    document.getElementById($(a.currentTarget).attr("href").replace("#","")).scrollIntoView({behavior: 'smooth' });
                // }
        })  
</script>


    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                    <li>
                        <a href="/atom.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                

                

                

                
                    <li>
                        <a target="_blank"  href="https://github.com/qoosuperman">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Anthony Chao 2026 
                    <br>
                    
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://qoosuperman.github.io/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->


<script>
    // dynamic User by Hux
    var _gaId = 'UA-153986590-1';
    var _gaDomain = 'yoursite';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>




<!-- Baidu Tongji -->

<script>
    // dynamic User by Hux
    var _baId = 'xxx';

    // Originial
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?" + _baId;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
</script>






	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>
<!-- Image to hack wechat -->
<img src="https://qoosuperman.github.io/img/icon_wechat.png" alt="prevent_hack" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
